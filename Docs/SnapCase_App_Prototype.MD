# PRD.md — Snapcase “Design & Order” Web App (v0)

*Last updated: {{today}}  • Owner: Ethan Trifari  • Engineering Lead: TBA  • Repo: snapcase-app*

## 0) Summary

Build a minimal but production‑ready web app at **`app.snapcase.ai`** where customers can select their phone model, design a case, pay, and have it fulfilled via **Printful**. Marketing site remains on **Squarespace** at `snapcase.ai` and links into the app.

**Primary flow:** /design → /checkout → /thank‑you → /order/:id.
**Editor:** Prefer **Printful Embedded Design Maker (EDM)**; if not available, fall back to a custom lightweight editor (Fabric.js/Konva.js) that exports a 300‑DPI PNG and uses Printful Orders API.

## 1) Goals & Non‑Goals

**Goals**

* Replicate the kiosk “Pick → Design → Pay” experience on web.
* Ship a working prototype with Stripe payments and Printful fulfillment.
* Maintain brand consistency with the Snapcase CX/UX/Brand Guide.

**Non‑Goals (v0)**

* Accounts/profiles, coupons, gift wrap, tax-exempt logic, kiosk pickup sync.

## 2) Users & Stories

* **Shopper (guest)**: “I want to make a case from my photos and get it shipped fast.”
* **Returning shopper** (later): “I want to reorder or remix a saved design.”
* **Operator**: “I want orders to appear in Printful, with statuses sent back to the app.”

## 3) Scope (v0)

* Devices: Recent iPhone & Samsung models (top ~12 across both).
* Case types: Snap (start) and Tough (add next).
* Editor: Image upload, crop/zoom, text, simple stickers; **safe‑area** + **DPI guard**.
* Payments: **Stripe Checkout** (test → live).
* Fulfillment: Printful orders (confirm immediately).
* Status: basic order status page + email receipt (Stripe email OK at v0).

## 4) Constraints & Assumptions

* **Squarespace** powers apex (`snapcase.ai`), **Vercel** hosts app on subdomain (`app.snapcase.ai`). DNS: Squarespace registry; CNAME for `app` to Vercel.
* **EDM access may be gated**; provide Plan‑B editor toggle via env flag.
* **Back‑only print**; communicate during design/review.

## 5) UX Requirements (must‑haves)

* Hero → CTA from Squarespace to app.
* **/design** page contains:

  1. Device picker (brand/model/case).
  2. Editor surface (EDM iframe or Fabric.js canvas).
  3. Clear notes: back‑only print; DPI warnings; safe area overlay.
* **/checkout** shows item summary, shipping options (Standard/Express), price, and proceeds to Stripe Checkout.
* **/thank‑you** confirms order; displays order id; link to track when webhook updates.

## 6) Accessibility & NFRs

* **WCAG AA** contrast, keyboard navigation for all interactive elements, visible focus ring.
* **Perf:** FCP < 1.5s, TTI < 3s on 4G; editor loads within 2s after route.
* **Security:** Secrets server‑side only; Stripe PCI handled by Stripe UI; rate‑limit API routes.
* **Privacy:** Link to Privacy/UGC policy on every page.

## 7) Architecture

```
Squarespace (snapcase.ai) → CTA → app.snapcase.ai (Vercel/Next.js 14)
  ├─ /design (EDM iframe or Fabric.js)
  ├─ /checkout (Stripe redirect)
  ├─ /thank-you (confirms payment; creates order if not already)
  ├─ /order/[id] (status)
  └─ /api/* (serverless routes)
      • /api/edm/nonce (POST) → Printful EDM Nonce
      • /api/catalog/phones (GET) → list supported variants
      • /api/checkout (POST) → Stripe Checkout Session
      • /api/order/create (POST) → Printful order (confirm=true)
      • /api/webhooks/stripe (POST) → mark paid
      • /api/webhooks/printful (POST) → update status
```

### Tech choices

* **Next.js 14 (App Router)**, **TypeScript**, **Tailwind** (+ design tokens), **shadcn/ui**.
* **Stripe** (Checkout first; Element later).
* **Printful API** (EDM + Orders).
* Utility: **Zod** for input validation, **SWR**/**React Query** for data fetching, **Rate limiting** (Upstash/edge or simple in‑memory for v0).

## 8) API Contracts (v0)

### 8.1 `POST /api/edm/nonce`

**Body** `{ externalProductId: string, userAgent?: string, ip?: string }`
**Response** `{ nonce: string }`
**Notes**: Server → `POST https://api.printful.com/embedded-designer/nonces` with Bearer token.

### 8.2 `GET /api/catalog/phones`

**Query**: none (first pass uses a curated mapping)
**Response** `[{ brand: 'apple'|'samsung', model: 'iPhone 15', caseType: 'snap'|'tough', productId: number, variantId: number }]`

### 8.3 `POST /api/checkout`

**Body** `{ price: number, email?: string, shippingAddress?: {...}, metadata?: {...} }`
**Response** `{ url: string }` // Stripe Checkout Session URL

### 8.4 `POST /api/order/create`

**Body** `{ templateId?: string, variantId: number, recipient: {...}, items?: [...], externalId?: string }`
**Response** `{ printfulOrderId: number, status: 'created'|'failed', errors?: string[] }`

### 8.5 Webhooks

* **Stripe:** `checkout.session.completed` → mark order paid, persist `payment_intent`, `customer_email`.
* **Printful:** `order_created`, `order_updated`, `package_shipped` → update status and tracking.

## 9) Data Model (Typescript)

```ts
export type Variant = { brand:'apple'|'samsung'; model:string; caseType:'snap'|'tough'; productId:number; variantId:number };
export type DesignTemplate = { templateId:string; externalProductId:string; createdAt:string };
export type Order = { id:string; printfulOrderId?:number; status:'draft'|'paid'|'submitted'|'shipped'|'failed'; variantId:number; templateId?:string; price:number; email?:string; tracking?:{ carrier:string; code:string } };
```

## 10) Environment Variables (Vercel → Settings → Env Vars)

* `PRINTFUL_TOKEN` (private; EDM + Orders)
* `PRINTFUL_STORE_ID`
* `STRIPE_SECRET_KEY`
* `STRIPE_WEBHOOK_SECRET` (when configured)
* `NEXT_PUBLIC_APP_URL` = `https://app.snapcase.ai`
* `USE_EDM` = `true|false`

## 11) Feature Flags

* `USE_EDM` → switch between EDM and Plan‑B editor.
* `SHOW_EXPRESS_SHIPPING` → toggles express option in review.

## 12) Acceptance Criteria

* [ ] Visiting `/design` loads device picker and editor within 2s.
* [ ] Saving in EDM returns a `templateId` and advances to checkout.
* [ ] Stripe Checkout completes and redirects to `/thank‑you`.
* [ ] `/api/order/create` submits an order to Printful with **compatible** `variantId`; order appears in Printful dashboard.
* [ ] Printful webhook updates status to `shipped` with tracking.

## 13) Error Handling

* Low‑DPI upload → blocking modal with tips; allow proceed only after user confirms quality risk.
* Printful/Stripe failure → toast + retry; preserve design in localStorage.
* OOS/invalid variant → offer “Ship from web” or alternate model.

## 14) Observability

* Console + Vercel logs; structure logs with request id & user agent.
* Capture key funnel metrics: `editor_start`, `template_saved`, `checkout_started`, `payment_succeeded`, `order_created`, `order_shipped`.

## 15) Rollout & QA

* Dev → Preview → Prod in Vercel; feature flag for EDM.
* Stripe test cards; Printful Webhook Simulator.
* Lighthouse accessibility and performance scores ≥ 90.

## 16) Roadmap (v1.1+)

* Templates (collage, bold type), MagSafe option, accounts, referral codes, recycle coupon logic, kiosk pickup QR bridge.
